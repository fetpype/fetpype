
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../surface/">
      
      
        <link rel="next" href="../api_pipelines/">
      
      
      <link rel="icon" href="../media/fetpype_favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.20">
    
    
      
        <title>Nodes - Fetpype</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e53b48f4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../css/home.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#nodes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Fetpype" class="md-header__button md-logo" aria-label="Fetpype" data-md-component="logo">
      
  <img src="../media/fetpype_logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Fetpype
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Nodes
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Fetpype" class="md-nav__button md-logo" aria-label="Fetpype" data-md-component="logo">
      
  <img src="../media/fetpype_logo.png" alt="logo">

    </a>
    Fetpype
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    In-depth
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            In-depth
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../configs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Config files
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../input_data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    BIDS Input Data Preparation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../output_data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Output Data Structure
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../run_parts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Running parts of the pipeline
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Pipeline
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Pipeline
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../preprocessing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Preprocessing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reconstruction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Reconstruction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../segmentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Segmentation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../surface/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Surface Extraction
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Nodes
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Nodes
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#fetpype.nodes.dhcp" class="md-nav__link">
    <span class="md-ellipsis">
      dhcp
    </span>
  </a>
  
    <nav class="md-nav" aria-label="dhcp">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.dhcp.dhcp_pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      dhcp_pipeline
    </span>
  </a>
  
    <nav class="md-nav" aria-label="dhcp_pipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.dhcp.dhcp_pipeline--flags-can-be-either-all-seg-or-surf" class="md-nav__link">
    <span class="md-ellipsis">
      Flags can be either "-all", "-seg", or "-surf"
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fetpype.nodes.preprocessing" class="md-nav__link">
    <span class="md-ellipsis">
      preprocessing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="preprocessing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.preprocessing.CropStacksAndMasks" class="md-nav__link">
    <span class="md-ellipsis">
      CropStacksAndMasks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.preprocessing.CheckAffineResStacksAndMasks" class="md-nav__link">
    <span class="md-ellipsis">
      CheckAffineResStacksAndMasks
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CheckAffineResStacksAndMasks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.preprocessing.CheckAffineResStacksAndMasks.check_inplane_pos" class="md-nav__link">
    <span class="md-ellipsis">
      check_inplane_pos
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.preprocessing.CheckAndSortStacksAndMasks" class="md-nav__link">
    <span class="md-ellipsis">
      CheckAndSortStacksAndMasks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.preprocessing.run_prepro_cmd" class="md-nav__link">
    <span class="md-ellipsis">
      run_prepro_cmd
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fetpype.nodes.reconstruction" class="md-nav__link">
    <span class="md-ellipsis">
      reconstruction
    </span>
  </a>
  
    <nav class="md-nav" aria-label="reconstruction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.reconstruction.run_recon_cmd" class="md-nav__link">
    <span class="md-ellipsis">
      run_recon_cmd
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fetpype.nodes.segmentation" class="md-nav__link">
    <span class="md-ellipsis">
      segmentation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="segmentation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.segmentation.run_seg_cmd" class="md-nav__link">
    <span class="md-ellipsis">
      run_seg_cmd
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fetpype.nodes.surface_extraction" class="md-nav__link">
    <span class="md-ellipsis">
      surface_extraction
    </span>
  </a>
  
    <nav class="md-nav" aria-label="surface_extraction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.surface_extraction.run_surf_cmd" class="md-nav__link">
    <span class="md-ellipsis">
      run_surf_cmd
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fetpype.nodes.utils" class="md-nav__link">
    <span class="md-ellipsis">
      utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.utils.get_directory" class="md-nav__link">
    <span class="md-ellipsis">
      get_directory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.utils.get_mount_docker" class="md-nav__link">
    <span class="md-ellipsis">
      get_mount_docker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.utils.get_run_id" class="md-nav__link">
    <span class="md-ellipsis">
      get_run_id
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api_pipelines/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pipelines
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api_utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Utils
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api_workflows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Workflows
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#fetpype.nodes.dhcp" class="md-nav__link">
    <span class="md-ellipsis">
      dhcp
    </span>
  </a>
  
    <nav class="md-nav" aria-label="dhcp">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.dhcp.dhcp_pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      dhcp_pipeline
    </span>
  </a>
  
    <nav class="md-nav" aria-label="dhcp_pipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.dhcp.dhcp_pipeline--flags-can-be-either-all-seg-or-surf" class="md-nav__link">
    <span class="md-ellipsis">
      Flags can be either "-all", "-seg", or "-surf"
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fetpype.nodes.preprocessing" class="md-nav__link">
    <span class="md-ellipsis">
      preprocessing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="preprocessing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.preprocessing.CropStacksAndMasks" class="md-nav__link">
    <span class="md-ellipsis">
      CropStacksAndMasks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.preprocessing.CheckAffineResStacksAndMasks" class="md-nav__link">
    <span class="md-ellipsis">
      CheckAffineResStacksAndMasks
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CheckAffineResStacksAndMasks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.preprocessing.CheckAffineResStacksAndMasks.check_inplane_pos" class="md-nav__link">
    <span class="md-ellipsis">
      check_inplane_pos
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.preprocessing.CheckAndSortStacksAndMasks" class="md-nav__link">
    <span class="md-ellipsis">
      CheckAndSortStacksAndMasks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.preprocessing.run_prepro_cmd" class="md-nav__link">
    <span class="md-ellipsis">
      run_prepro_cmd
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fetpype.nodes.reconstruction" class="md-nav__link">
    <span class="md-ellipsis">
      reconstruction
    </span>
  </a>
  
    <nav class="md-nav" aria-label="reconstruction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.reconstruction.run_recon_cmd" class="md-nav__link">
    <span class="md-ellipsis">
      run_recon_cmd
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fetpype.nodes.segmentation" class="md-nav__link">
    <span class="md-ellipsis">
      segmentation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="segmentation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.segmentation.run_seg_cmd" class="md-nav__link">
    <span class="md-ellipsis">
      run_seg_cmd
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fetpype.nodes.surface_extraction" class="md-nav__link">
    <span class="md-ellipsis">
      surface_extraction
    </span>
  </a>
  
    <nav class="md-nav" aria-label="surface_extraction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.surface_extraction.run_surf_cmd" class="md-nav__link">
    <span class="md-ellipsis">
      run_surf_cmd
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fetpype.nodes.utils" class="md-nav__link">
    <span class="md-ellipsis">
      utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.utils.get_directory" class="md-nav__link">
    <span class="md-ellipsis">
      get_directory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.utils.get_mount_docker" class="md-nav__link">
    <span class="md-ellipsis">
      get_mount_docker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fetpype.nodes.utils.get_run_id" class="md-nav__link">
    <span class="md-ellipsis">
      get_run_id
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="nodes">Nodes</h1>


<div class="doc doc-object doc-module">



<h2 id="fetpype.nodes.dhcp" class="doc doc-heading">
            <code>dhcp</code>


</h2>

    <div class="doc doc-contents first">

        <p>Nodes that implement the dHCP pipeline for fetal data.</p>
<p>Version from <a href="https://github.com/GerardMJuan/dhcp-structural-pipeline">https://github.com/GerardMJuan/dhcp-structural-pipeline</a>
, which is a fork of the original dataset
<a href="https://github.com/BioMedIA/dhcp-structural-pipeline">https://github.com/BioMedIA/dhcp-structural-pipeline</a>
with several fixes and changes</p>
<p>The docker image, where everything works "well", is:
<a href="https://hub.docker.com/r/gerardmartijuan/dhcp-pipeline-multifact">https://hub.docker.com/r/gerardmartijuan/dhcp-pipeline-multifact</a></p>
<p>TODO: specify the changes from one version to another.</p>










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="fetpype.nodes.dhcp.dhcp_pipeline" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">dhcp_pipeline</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">gestational_age</span><span class="p">,</span> <span class="n">pre_command</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">dhcp_image</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Run the dhcp segmentation pipeline on a single subject.
The script needs to create the output folders and put the mask
there so that the docker image can find it and doesn't run bet.
TODO: don't do it that convoluted.
TODO: Be able to input the number of threads</p>
<h4 id="fetpype.nodes.dhcp.dhcp_pipeline--flags-can-be-either-all-seg-or-surf">Flags can be either "-all", "-seg", or "-surf"</h4>


            <details class="quote">
              <summary>Source code in <code>fetpype/nodes/dhcp.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dhcp_pipeline</span><span class="p">(</span>
    <span class="n">T2</span><span class="p">,</span>
    <span class="n">mask</span><span class="p">,</span>
    <span class="n">gestational_age</span><span class="p">,</span>
    <span class="n">pre_command</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">dhcp_image</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">flag</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run the dhcp segmentation pipeline on a single subject.</span>
<span class="sd">    The script needs to create the output folders and put the mask</span>
<span class="sd">    there so that the docker image can find it and doesn&#39;t run bet.</span>
<span class="sd">    TODO: don&#39;t do it that convoluted.</span>
<span class="sd">    TODO: Be able to input the number of threads</span>

<span class="sd">    # Flags can be either &quot;-all&quot;, &quot;-seg&quot;, or &quot;-surf&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>

    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;dhcp_output&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Basename of the T2 file</span>
    <span class="n">recon_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">T2</span><span class="p">)</span>

    <span class="c1"># Copy T2 to output dir</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">recon_file_name</span><span class="p">))</span>

    <span class="c1"># Copy mask to output dir with the correct name</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;segmentations&quot;</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># check if mask file exists. If not, create it</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span>
        <span class="n">mask</span><span class="p">,</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">output_dir</span><span class="p">,</span>
            <span class="s2">&quot;segmentations&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">recon_file_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.nii.gz&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_brain_mask.nii.gz&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;docker&quot;</span> <span class="ow">in</span> <span class="n">pre_command</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">pre_command</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;-v </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">:/data &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dhcp_image</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;/data/</span><span class="si">{</span><span class="n">recon_file_name</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gestational_age</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="s2">&quot;-data-dir /data &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;-t </span><span class="si">{</span><span class="n">threads</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="s2">&quot;-c 0 &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="p">)</span>

    <span class="k">elif</span> <span class="s2">&quot;singularity&quot;</span> <span class="ow">in</span> <span class="n">pre_command</span><span class="p">:</span>
        <span class="c1"># Do we need FSL for this pipeline? add in the precommand</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">pre_command</span> <span class="o">+</span> <span class="n">dhcp_image</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;/usr/local/src/structural-pipeline/fetal-pipeline.sh &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">T2</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gestational_age</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;-data-dir &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;-t </span><span class="si">{</span><span class="n">threads</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="s2">&quot;-c 0 &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;pre_command must either contain docker or singularity.&quot;</span>
        <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

    <span class="c1"># assert if the output files exist</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">output_dir</span><span class="p">,</span>
            <span class="s2">&quot;segmentations&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">recon_file_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.nii.gz&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_all_labels.nii.gz&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">),</span> <span class="s2">&quot;Error, segmentations file does not exist&quot;</span>

    <span class="k">return</span> <span class="n">output_dir</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="fetpype.nodes.preprocessing" class="doc doc-heading">
            <code>preprocessing</code>


</h2>

    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="fetpype.nodes.preprocessing.CropStacksAndMasks" class="doc doc-heading">
            <code>CropStacksAndMasks</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="nipype.interfaces.base.BaseInterface">BaseInterface</span></code></p>


        <p>Interface to crop the field of view of an image and its mask.</p>
<p>This class provides functionality to crop a Nifti image
and its corresponding mask to the bounding box defined by
the mask. It also allows for adding boundaries around the
cropped region.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>image</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input image filename</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask</code>
            </td>
            <td>
                  <code>input; str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input mask filename</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>boundary</code>
            </td>
            <td>
                  <code>input; int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Padding (in mm) to be set around
                    the cropped image and mask.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>is_enabled</code>
            </td>
            <td>
                  <code>input; bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether cropping and masking are enabled.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_image</code>
            </td>
            <td>
                  <code>output; str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the cropped image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_mask</code>
            </td>
            <td>
                  <code>output; str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the cropped mask.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">fetpype.nodes.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">CropStacksAndMasks</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">crop_input</span> <span class="o">=</span> <span class="n">CropStacksAndMasks</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">crop_input</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="s1">&#39;sub-01_acq-haste_run-1_T2w.nii.gz&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">crop_input</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="s1">&#39;sub-01_acq-haste_run-1_T2w_mask.nii.gz&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">crop_input</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>


<details class="references" open>
  <summary>References</summary>
  <ul>
<li>Michael Ebner's NiftyMIC repository:
https://github.com/gift-surg/NiftyMIC</li>
</ul>
</details>







              <details class="quote">
                <summary>Source code in <code>fetpype/nodes/preprocessing.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CropStacksAndMasks</span><span class="p">(</span><span class="n">BaseInterface</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interface to crop the field of view of an image and its mask.</span>

<span class="sd">    This class provides functionality to crop a Nifti image</span>
<span class="sd">    and its corresponding mask to the bounding box defined by</span>
<span class="sd">    the mask. It also allows for adding boundaries around the</span>
<span class="sd">    cropped region.</span>

<span class="sd">    Args:</span>
<span class="sd">        image (str): Input image filename</span>
<span class="sd">        mask (input; str): Input mask filename</span>
<span class="sd">        boundary (input; int):  Padding (in mm) to be set around</span>
<span class="sd">                                the cropped image and mask.</span>
<span class="sd">        is_enabled (input; bool): Whether cropping and masking are enabled.</span>
<span class="sd">        output_image (output; str): Path to the cropped image.</span>
<span class="sd">        output_mask (output; str): Path to the cropped mask.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from fetpype.nodes.preprocessing import CropStacksAndMasks</span>
<span class="sd">        &gt;&gt;&gt; crop_input = CropStacksAndMasks()</span>
<span class="sd">        &gt;&gt;&gt; crop_input.inputs.image = &#39;sub-01_acq-haste_run-1_T2w.nii.gz&#39;</span>
<span class="sd">        &gt;&gt;&gt; crop_input.inputs.mask = &#39;sub-01_acq-haste_run-1_T2w_mask.nii.gz&#39;</span>
<span class="sd">        &gt;&gt;&gt; crop_input.run() # doctest: +SKIP</span>

<span class="sd">    References:</span>
<span class="sd">        - Michael Ebner&#39;s NiftyMIC repository:</span>
<span class="sd">        https://github.com/gift-surg/NiftyMIC</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">input_spec</span> <span class="o">=</span> <span class="n">CropStacksAndMasksInputSpec</span>
    <span class="n">output_spec</span> <span class="o">=</span> <span class="n">CropStacksAndMasksOutputSpec</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_gen_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;output_image&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">image</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;output_mask&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">mask</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_crop_stack_and_mask</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image_path</span><span class="p">,</span>
        <span class="n">mask_path</span><span class="p">,</span>
        <span class="n">boundary_i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">boundary_j</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">boundary_k</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;mm&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Crops the input image to the field of view given by the bounding box</span>
<span class="sd">        around its mask.</span>

<span class="sd">        Args:</span>
<span class="sd">            image_path (str): Path to a Nifti image.</span>
<span class="sd">            mask_path (str): Path to the corresponding Nifti mask.</span>
<span class="sd">            boundary_i (int):   Boundary to add to the bounding box in</span>
<span class="sd">                                the i direction.</span>
<span class="sd">            boundary_j (int):   Boundary to add to the bounding box in</span>
<span class="sd">                                the j direction.</span>
<span class="sd">            boundary_k (int):   Boundary to add to the bounding box in</span>
<span class="sd">                                the k direction.</span>
<span class="sd">            unit (str): The unit defining the dimension size in Nifti.</span>

<span class="sd">        Returns:</span>
<span class="sd">            image_cropped:  Image cropped to the bounding box of mask_ni,</span>
<span class="sd">                            including boundary.</span>
<span class="sd">            mask_cropped: Mask cropped to its bounding box.</span>

<span class="sd">        Notes:</span>
<span class="sd">            Code inspired by Michael Ebner:</span>
<span class="sd">            https://github.com/gift-surg/NiftyMIC/blob/master/niftymic/base/stack.py</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Working on </span><span class="si">{</span><span class="n">image_path</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">mask_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">image_ni</span> <span class="o">=</span> <span class="n">ni</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
        <span class="n">mask_ni</span> <span class="o">=</span> <span class="n">ni</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">mask_path</span><span class="p">)</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">image_ni</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_ni</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>

        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)),</span> <span class="p">(</span>
            <span class="s2">&quot;For a correct cropping, the image should be larger &quot;</span>
            <span class="s2">&quot;or equal to the mask.&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Get rectangular region surrounding the masked voxels</span>
        <span class="p">[</span><span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">z_range</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rectangular_masked_region</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">z_range</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Cropping to bounding box of mask led to an empty image.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;mm&quot;</span><span class="p">:</span>
            <span class="n">spacing</span> <span class="o">=</span> <span class="n">image_ni</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()</span>
            <span class="n">boundary_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">boundary_i</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">boundary_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">boundary_j</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">spacing</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">boundary_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">boundary_k</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">spacing</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

        <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">im</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)]</span>
        <span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">boundary_i</span><span class="p">])</span>
        <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">boundary_i</span><span class="p">])</span>

        <span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">boundary_j</span><span class="p">])</span>
        <span class="n">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">boundary_j</span><span class="p">])</span>

        <span class="n">z_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">z_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">boundary_k</span><span class="p">])</span>
        <span class="n">z_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">z_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">boundary_k</span><span class="p">])</span>

        <span class="n">new_origin</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">ni</span><span class="o">.</span><span class="n">affines</span><span class="o">.</span><span class="n">apply_affine</span><span class="p">(</span>
                <span class="n">image_ni</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="p">[</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">z_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="p">)</span>
        <span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">new_affine</span> <span class="o">=</span> <span class="n">image_ni</span><span class="o">.</span><span class="n">affine</span>
        <span class="n">new_affine</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_origin</span>

        <span class="n">image_cropped</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span>
            <span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># noqa: E203</span>
            <span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># noqa: E203</span>
            <span class="n">z_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">z_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># noqa: E203</span>
        <span class="p">]</span>
        <span class="n">mask_cropped</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span>
            <span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># noqa: E203</span>
            <span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># noqa: E203</span>
            <span class="n">z_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">z_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># noqa: E203</span>
        <span class="p">]</span>

        <span class="n">image_cropped</span> <span class="o">=</span> <span class="n">ni</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">image_cropped</span><span class="p">,</span> <span class="n">new_affine</span><span class="p">)</span>
        <span class="n">mask_cropped</span> <span class="o">=</span> <span class="n">ni</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">mask_cropped</span><span class="p">,</span> <span class="n">new_affine</span><span class="p">)</span>
        <span class="n">ni</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">image_cropped</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_filename</span><span class="p">(</span><span class="s2">&quot;output_image&quot;</span><span class="p">))</span>
        <span class="n">ni</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">mask_cropped</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_filename</span><span class="p">(</span><span class="s2">&quot;output_mask&quot;</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_rectangular_masked_region</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the bounding box around the given mask.</span>
<span class="sd">        Code inspired by Michael Ebner:</span>
<span class="sd">        https://github.com/gift-surg/NiftyMIC/blob/master/niftymic/base/stack.py</span>

<span class="sd">        Args:</span>
<span class="sd">            mask (np.ndarray): Input mask.</span>
<span class="sd">            range_x (tuple): Pair defining x interval of mask in voxel space.</span>
<span class="sd">            range_y (tuple): Pair defining y interval of mask in voxel space.</span>
<span class="sd">            range_z (tuple): Pair defining z interval of mask in voxel space.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: A tuple containing the bounding box ranges for x, y, and z.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span>
        <span class="c1"># Define the dimensions along which to sum the data</span>
        <span class="n">sum_axis</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">range_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Non-zero elements of numpy array along the the 3 dimensions</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">sum_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">sum_axis</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">ran</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">sum_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">ran</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ran</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">range_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">range_list</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runtime</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">:</span>
            <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">boundary</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_crop_stack_and_mask</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">image</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span>
                <span class="n">boundary_i</span><span class="o">=</span><span class="n">boundary</span><span class="p">,</span>
                <span class="n">boundary_j</span><span class="o">=</span><span class="n">boundary</span><span class="p">,</span>
                <span class="n">boundary_k</span><span class="o">=</span><span class="n">boundary</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;cp </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">image</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_gen_filename</span><span class="p">(</span><span class="s1">&#39;output_image&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;cp </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">mask</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_gen_filename</span><span class="p">(</span><span class="s1">&#39;output_mask&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;output_image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_filename</span><span class="p">(</span><span class="s2">&quot;output_image&quot;</span><span class="p">)</span>
        <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;output_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_filename</span><span class="p">(</span><span class="s2">&quot;output_mask&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outputs</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="fetpype.nodes.preprocessing.CheckAffineResStacksAndMasks" class="doc doc-heading">
            <code>CheckAffineResStacksAndMasks</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="nipype.interfaces.base.BaseInterface">BaseInterface</span></code></p>


        <p>Interface to check that the shape of stacks and masks are consistent.
(e.g. no trailing dimensions of size 1) and stack ordering in the last dimension.
If enabled, also checks that the resolution, affine, and shape of the
stacks and masks are consistent. Discards the stack and mask if they are
not.</p>
<p>Args:</p>
<pre><code>stacks (input; list): List of input stacks.
masks (input; list): List of input masks.
is_enabled (input; bool): Whether the check is enabled.
output_stacks (output; list): List of stacks that passed the check.
output_masks (output; list): List of masks that passed the check.
</code></pre>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">fetpype.nodes.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">CheckAffineResStacksAndMasks</span> <span class="c1"># noqa: E501</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">check_input</span> <span class="o">=</span> <span class="n">CheckAffineResStacksAndMasks</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">check_input</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">stacks</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sub-01_acq-haste_run-1_T2w.nii.gz&#39;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">check_input</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sub-01_acq-haste_run-1_T2w_mask.nii.gz&#39;</span><span class="p">]</span>  <span class="c1"># noqa: E501</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">check_input</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>








              <details class="quote">
                <summary>Source code in <code>fetpype/nodes/preprocessing.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CheckAffineResStacksAndMasks</span><span class="p">(</span><span class="n">BaseInterface</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interface to check that the shape of stacks and masks are consistent.</span>
<span class="sd">    (e.g. no trailing dimensions of size 1) and stack ordering in the last dimension.</span>
<span class="sd">    If enabled, also checks that the resolution, affine, and shape of the</span>
<span class="sd">    stacks and masks are consistent. Discards the stack and mask if they are</span>
<span class="sd">    not.</span>

<span class="sd">    Args:</span>

<span class="sd">        stacks (input; list): List of input stacks.</span>
<span class="sd">        masks (input; list): List of input masks.</span>
<span class="sd">        is_enabled (input; bool): Whether the check is enabled.</span>
<span class="sd">        output_stacks (output; list): List of stacks that passed the check.</span>
<span class="sd">        output_masks (output; list): List of masks that passed the check.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from fetpype.nodes.preprocessing import CheckAffineResStacksAndMasks # noqa: E501</span>
<span class="sd">        &gt;&gt;&gt; check_input = CheckAffineResStacksAndMasks()</span>
<span class="sd">        &gt;&gt;&gt; check_input.inputs.stacks = [&#39;sub-01_acq-haste_run-1_T2w.nii.gz&#39;]</span>
<span class="sd">        &gt;&gt;&gt; check_input.inputs.masks = [&#39;sub-01_acq-haste_run-1_T2w_mask.nii.gz&#39;]  # noqa: E501</span>
<span class="sd">        &gt;&gt;&gt; check_input.run() # doctest: +SKIP</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">input_spec</span> <span class="o">=</span> <span class="n">CheckAffineResStacksAndMasksInputSpec</span>
    <span class="n">output_spec</span> <span class="o">=</span> <span class="n">CheckAffineResStacksAndMasksOutputSpec</span>
    <span class="n">_results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_squeeze_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">dim</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">arr</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compare_resolution_affine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s1</span> <span class="o">!=</span> <span class="n">s2</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">r1</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">r2</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">r1</span> <span class="o">-</span> <span class="n">r2</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1e-3</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">a1</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">a2</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a1</span> <span class="o">-</span> <span class="n">a2</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1e-3</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_inplane_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">r1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the smallest dimension of the stack is the last one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vx_str</span> <span class="o">=</span> <span class="s2">&quot; x &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">r1</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">r1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">r1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Inconsistent voxel sizes at dimensions 0 and 1 &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;for </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> (voxel size = (</span><span class="si">{</span><span class="n">vx_str</span><span class="si">}</span><span class="s2">)). &quot;</span>
            <span class="s2">&quot;Are you sure that the data are &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;formatted as in-plane x in-plane x through-plane?&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runtime</span><span class="p">):</span>
        <span class="n">stacks_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">masks_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="n">maskp</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">stacks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">masks</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">skip_stack</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">out_stack</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gen_filename</span><span class="p">(</span><span class="s2">&quot;output_dir&quot;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">imp</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">out_mask</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gen_filename</span><span class="p">(</span><span class="s2">&quot;output_dir&quot;</span><span class="p">),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">maskp</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">image_ni</span> <span class="o">=</span> <span class="n">ni</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">stacks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">mask_ni</span> <span class="o">=</span> <span class="n">ni</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_squeeze_dim</span><span class="p">(</span><span class="n">image_ni</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_squeeze_dim</span><span class="p">(</span><span class="n">mask_ni</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">image_ni</span> <span class="o">=</span> <span class="n">ni</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">image_ni</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">image_ni</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
            <span class="n">mask_ni</span> <span class="o">=</span> <span class="n">ni</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask_ni</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">mask_ni</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">:</span>
                <span class="n">im_res</span> <span class="o">=</span> <span class="n">image_ni</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;pixdim&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">mask_res</span> <span class="o">=</span> <span class="n">mask_ni</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;pixdim&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">im_aff</span> <span class="o">=</span> <span class="n">image_ni</span><span class="o">.</span><span class="n">affine</span>
                <span class="n">mask_aff</span> <span class="o">=</span> <span class="n">mask_ni</span><span class="o">.</span><span class="n">affine</span>
                <span class="n">im_shape</span> <span class="o">=</span> <span class="n">image_ni</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">mask_shape</span> <span class="o">=</span> <span class="n">mask_ni</span><span class="o">.</span><span class="n">shape</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_inplane_pos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">stacks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">im_res</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">compare_resolution_affine</span><span class="p">(</span>
                    <span class="n">im_res</span><span class="p">,</span> <span class="n">im_aff</span><span class="p">,</span> <span class="n">mask_res</span><span class="p">,</span> <span class="n">mask_aff</span><span class="p">,</span> <span class="n">im_shape</span><span class="p">,</span> <span class="n">mask_shape</span>
                <span class="p">):</span>
                    <span class="n">skip_stack</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Resolution/shape/affine mismatch -- &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Skipping the stack </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">imp</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;and mask </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">maskp</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">skip_stack</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Mask </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">maskp</span><span class="p">)</span><span class="si">}</span><span class="s2"> is empty -- &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Skipping the stack </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">imp</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;and mask </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">maskp</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_stack</span><span class="p">:</span>
                <span class="n">ni</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">image_ni</span><span class="p">,</span> <span class="n">out_stack</span><span class="p">)</span>
                <span class="n">ni</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">mask_ni</span><span class="p">,</span> <span class="n">out_mask</span><span class="p">)</span>
                <span class="n">stacks_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">out_stack</span><span class="p">))</span>
                <span class="n">masks_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">out_mask</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s2">&quot;output_stacks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stacks_out</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s2">&quot;output_masks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">masks_out</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stacks_out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;All stacks and masks were &quot;</span>
                <span class="s2">&quot;discarded during the metadata check.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">runtime</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_gen_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;output_dir&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;output_stacks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;output_stacks&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_filename</span><span class="p">(</span><span class="s2">&quot;output_stacks&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;output_masks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;output_masks&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_filename</span><span class="p">(</span><span class="s2">&quot;output_masks&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">outputs</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="fetpype.nodes.preprocessing.CheckAffineResStacksAndMasks.check_inplane_pos" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">check_inplane_pos</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Check if the smallest dimension of the stack is the last one.</p>


            <details class="quote">
              <summary>Source code in <code>fetpype/nodes/preprocessing.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_inplane_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">r1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the smallest dimension of the stack is the last one.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vx_str</span> <span class="o">=</span> <span class="s2">&quot; x &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">r1</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">r1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">r1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Inconsistent voxel sizes at dimensions 0 and 1 &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;for </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> (voxel size = (</span><span class="si">{</span><span class="n">vx_str</span><span class="si">}</span><span class="s2">)). &quot;</span>
        <span class="s2">&quot;Are you sure that the data are &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;formatted as in-plane x in-plane x through-plane?&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="fetpype.nodes.preprocessing.CheckAndSortStacksAndMasks" class="doc doc-heading">
            <code>CheckAndSortStacksAndMasks</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="nipype.interfaces.base.BaseInterface">BaseInterface</span></code></p>


        <p>Interface to check the input stacks and masks and make sure that
all stacks have a corresponding mask.</p>
<p>Args:</p>
<pre><code>stacks (input; list): List of input stacks.
masks (input; list): List of input masks.

output_stacks (output; list): List of stacks that passed the check.
output_masks (output; list): List of masks that passed the check.
</code></pre>
<p>Examples:
    &gt;&gt;&gt; from fetpype.nodes.preprocessing import CheckAndSortStacksAndMasks
    &gt;&gt;&gt; check_input = CheckAndSortStacksAndMasks()
    &gt;&gt;&gt; check_input.inputs.stacks = ['sub-01_acq-haste_run-1_T2w.nii.gz']
    &gt;&gt;&gt; check_input.inputs.masks = ['sub-01_acq-haste_run-1_mask.nii.gz']
    &gt;&gt;&gt; check_input.run() # doctest: +SKIP</p>








              <details class="quote">
                <summary>Source code in <code>fetpype/nodes/preprocessing.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CheckAndSortStacksAndMasks</span><span class="p">(</span><span class="n">BaseInterface</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interface to check the input stacks and masks and make sure that</span>
<span class="sd">    all stacks have a corresponding mask.</span>

<span class="sd">    Args:</span>

<span class="sd">        stacks (input; list): List of input stacks.</span>
<span class="sd">        masks (input; list): List of input masks.</span>

<span class="sd">        output_stacks (output; list): List of stacks that passed the check.</span>
<span class="sd">        output_masks (output; list): List of masks that passed the check.</span>
<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; from fetpype.nodes.preprocessing import CheckAndSortStacksAndMasks</span>
<span class="sd">        &gt;&gt;&gt; check_input = CheckAndSortStacksAndMasks()</span>
<span class="sd">        &gt;&gt;&gt; check_input.inputs.stacks = [&#39;sub-01_acq-haste_run-1_T2w.nii.gz&#39;]</span>
<span class="sd">        &gt;&gt;&gt; check_input.inputs.masks = [&#39;sub-01_acq-haste_run-1_mask.nii.gz&#39;]</span>
<span class="sd">        &gt;&gt;&gt; check_input.run() # doctest: +SKIP</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">input_spec</span> <span class="o">=</span> <span class="n">CheckAndSortStacksAndMasksInputSpec</span>
    <span class="n">output_spec</span> <span class="o">=</span> <span class="n">CheckAndSortStacksAndMasksOutputSpec</span>
    <span class="n">_results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runtime</span><span class="p">):</span>

        <span class="c1"># Check that stacks and masks run_ids match</span>
        <span class="n">stacks_run</span> <span class="o">=</span> <span class="n">get_run_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">stacks</span><span class="p">)</span>
        <span class="n">masks_run</span> <span class="o">=</span> <span class="n">get_run_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">masks</span><span class="p">)</span>

        <span class="n">out_stacks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">out_masks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stacks_run</span><span class="p">):</span>
            <span class="n">in_stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">stacks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">masks_run</span><span class="p">:</span>
                <span class="n">out_stack</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_gen_filename</span><span class="p">(</span><span class="s2">&quot;output_dir_stacks&quot;</span><span class="p">),</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">in_stack</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">in_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="n">masks_run</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span>
                <span class="n">out_mask</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_gen_filename</span><span class="p">(</span><span class="s2">&quot;output_dir_masks&quot;</span><span class="p">),</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">in_mask</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">out_stacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_stack</span><span class="p">)</span>
                <span class="n">out_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_mask</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Stack </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">stacks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="si">}</span><span class="s2"> has &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;no corresponding mask (existing IDs: </span><span class="si">{</span><span class="n">masks_run</span><span class="si">}</span><span class="s2">).&quot;</span>
                <span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cp </span><span class="si">{</span><span class="n">in_stack</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">out_stack</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cp </span><span class="si">{</span><span class="n">in_mask</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">out_mask</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s2">&quot;output_stacks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_stacks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s2">&quot;output_masks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_masks</span>
        <span class="k">return</span> <span class="n">runtime</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_gen_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;output_dir_stacks&quot;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;stacks&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">path</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;output_dir_masks&quot;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;masks&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">path</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;output_stacks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s2">&quot;output_stacks&quot;</span><span class="p">]</span>
        <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;output_masks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s2">&quot;output_masks&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">outputs</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h3 id="fetpype.nodes.preprocessing.run_prepro_cmd" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run_prepro_cmd</span><span class="p">(</span><span class="n">input_stacks</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">is_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">input_masks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">singularity_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">singularity_mount</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Run a preprocessing command on input stacks and masks.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_stacks</code>
            </td>
            <td>
                  <code><span title="str">str</span> or <span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input stacks to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cmd</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Command to run, with tags for input and output.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>is_enabled</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the command should be executed.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>input_masks</code>
            </td>
            <td>
                  <code><span title="str">str</span> or <span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input masks to process.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>singularity_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the Singularity executable.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>singularity_mount</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Mount point for Singularity.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    tuple: Output stacks and masks, if specified in the command.
           If only one of them is specified, returns that one.
           If none are specified, returns None.</p>


            <details class="quote">
              <summary>Source code in <code>fetpype/nodes/preprocessing.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_prepro_cmd</span><span class="p">(</span>
    <span class="n">input_stacks</span><span class="p">,</span>
    <span class="n">cmd</span><span class="p">,</span>
    <span class="n">is_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">input_masks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">singularity_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">singularity_mount</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a preprocessing command on input stacks and masks.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_stacks (str or list): Input stacks to process.</span>
<span class="sd">        cmd (str): Command to run, with tags for input and output.</span>
<span class="sd">        is_enabled (bool): Whether the command should be executed.</span>
<span class="sd">        input_masks (str or list, optional): Input masks to process.</span>
<span class="sd">        singularity_path (str, optional): Path to the Singularity executable.</span>
<span class="sd">        singularity_mount (str, optional): Mount point for Singularity.</span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: Output stacks and masks, if specified in the command.</span>
<span class="sd">               If only one of them is specified, returns that one.</span>
<span class="sd">               If none are specified, returns None.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">fetpype</span><span class="w"> </span><span class="kn">import</span> <span class="n">VALID_PREPRO_TAGS</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">fetpype.utils.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_and_tee</span>

    <span class="c1"># Important for mapnodes</span>
    <span class="n">unlist_stacks</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">unlist_masks</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_stacks</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">input_stacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_stacks</span><span class="p">]</span>
        <span class="n">unlist_stacks</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_masks</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">input_masks</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_masks</span><span class="p">]</span>
        <span class="n">unlist_masks</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">fetpype.nodes</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_valid_cmd</span><span class="p">,</span> <span class="n">get_directory</span><span class="p">,</span> <span class="n">get_mount_docker</span>

    <span class="n">is_valid_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">VALID_PREPRO_TAGS</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;&lt;output_stacks&gt;&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmd</span> <span class="ow">and</span> <span class="s2">&quot;&lt;output_masks&gt;&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;No output stacks or masks specified in the command. &quot;</span>
            <span class="s2">&quot;Please specify &lt;output_stacks&gt; and/or &lt;output_masks&gt;.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">is_enabled</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;output&quot;</span><span class="p">)</span>
        <span class="n">in_stacks_dir</span> <span class="o">=</span> <span class="n">get_directory</span><span class="p">(</span><span class="n">input_stacks</span><span class="p">)</span>
        <span class="n">in_stacks</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_stacks</span><span class="p">)</span>

        <span class="n">in_masks</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">in_masks_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">input_masks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">in_masks_dir</span> <span class="o">=</span> <span class="n">get_directory</span><span class="p">(</span><span class="n">input_masks</span><span class="p">)</span>
            <span class="n">in_masks</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_masks</span><span class="p">)</span>

        <span class="n">output_stacks</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">output_masks</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># In cmd, there will be things contained in &lt;&gt;.</span>
        <span class="c1"># Check that everything that is in &lt;&gt; is in valid_tags</span>
        <span class="c1"># If not, raise an error</span>

        <span class="c1"># Replace the tags in the command</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;input_stacks&gt;&quot;</span><span class="p">,</span> <span class="n">in_stacks</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;input_masks&gt;&quot;</span><span class="p">,</span> <span class="n">in_masks</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;&lt;output_stacks&gt;&quot;</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="n">output_stacks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">stack</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">stack</span> <span class="ow">in</span> <span class="n">input_stacks</span>
            <span class="p">]</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;output_stacks&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_stacks</span><span class="p">))</span>
        <span class="k">if</span> <span class="s2">&quot;&lt;output_masks&gt;&quot;</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">input_masks</span><span class="p">:</span>
                <span class="n">output_masks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">input_masks</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output_masks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">stack</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                        <span class="s2">&quot;_T2w&quot;</span><span class="p">,</span> <span class="s2">&quot;_mask&quot;</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">stack</span> <span class="ow">in</span> <span class="n">input_stacks</span>
                <span class="p">]</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;output_masks&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_masks</span><span class="p">))</span>

        <span class="k">if</span> <span class="s2">&quot;&lt;mount&gt;&quot;</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="n">mount_cmd</span> <span class="o">=</span> <span class="n">get_mount_docker</span><span class="p">(</span>
                <span class="n">in_stacks_dir</span><span class="p">,</span> <span class="n">in_masks_dir</span><span class="p">,</span> <span class="n">output_dir</span>
            <span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;mount&gt;&quot;</span><span class="p">,</span> <span class="n">mount_cmd</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;&lt;singularity_path&gt;&quot;</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="c1"># assume that if we have a singularity path,</span>
            <span class="c1"># we are using singularity and the</span>
            <span class="c1"># parameter has been set in the config file</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;singularity_path&gt;&quot;</span><span class="p">,</span> <span class="n">singularity_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;&lt;singularity_mount&gt;&quot;</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="c1"># assume that if we have a singularity mount path,</span>
            <span class="c1"># we are using singularity and the</span>
            <span class="c1"># parameter has been set in the config file</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;singularity_mount&gt;&quot;</span><span class="p">,</span> <span class="n">singularity_mount</span><span class="p">)</span>

        <span class="n">run_and_tee</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_stacks</span> <span class="o">=</span> <span class="n">input_stacks</span> <span class="k">if</span> <span class="s2">&quot;&lt;output_stacks&gt;&quot;</span> <span class="ow">in</span> <span class="n">cmd</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">output_masks</span> <span class="o">=</span> <span class="n">input_masks</span> <span class="k">if</span> <span class="s2">&quot;&lt;output_masks&gt;&quot;</span> <span class="ow">in</span> <span class="n">cmd</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">output_stacks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">unlist_stacks</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">output_stacks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">),</span> <span class="s2">&quot;More than one stack was returned, but unlist_stacks is True.&quot;</span>
        <span class="n">output_stacks</span> <span class="o">=</span> <span class="n">output_stacks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">output_masks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">unlist_masks</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">output_masks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">),</span> <span class="s2">&quot;More than one mask was returned, but unlist_masks is True.&quot;</span>
        <span class="n">output_masks</span> <span class="o">=</span> <span class="n">output_masks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">output_stacks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">output_masks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">output_stacks</span><span class="p">,</span> <span class="n">output_masks</span>
    <span class="k">elif</span> <span class="n">output_stacks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">output_stacks</span>
    <span class="k">elif</span> <span class="n">output_masks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">output_masks</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="fetpype.nodes.reconstruction" class="doc doc-heading">
            <code>reconstruction</code>


</h2>

    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="fetpype.nodes.reconstruction.run_recon_cmd" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run_recon_cmd</span><span class="p">(</span><span class="n">input_stacks</span><span class="p">,</span> <span class="n">input_masks</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">singularity_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">singularity_mount</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Run a reconstruction command with the given input stacks and masks.</p>
<p>Args:</p>
<pre><code>input_stacks (list): List of input stack file paths.
input_masks (list): List of input mask file paths.
cmd (str): Command to run, with placeholders for input and output.
cfg (object): Configuration object containing output directory
                and resolution.
singularity_path (str, optional): Path to the Singularity executable.
singularity_mount (str, optional): Mount point for Singularity.
</code></pre>
<p>Returns:
    str: Path to the output volume after reconstruction.</p>


            <details class="quote">
              <summary>Source code in <code>fetpype/nodes/reconstruction.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_recon_cmd</span><span class="p">(</span>
    <span class="n">input_stacks</span><span class="p">,</span>
    <span class="n">input_masks</span><span class="p">,</span>
    <span class="n">cmd</span><span class="p">,</span>
    <span class="n">cfg</span><span class="p">,</span>
    <span class="n">singularity_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">singularity_mount</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a reconstruction command with the given input stacks and masks.</span>

<span class="sd">    Args:</span>

<span class="sd">        input_stacks (list): List of input stack file paths.</span>
<span class="sd">        input_masks (list): List of input mask file paths.</span>
<span class="sd">        cmd (str): Command to run, with placeholders for input and output.</span>
<span class="sd">        cfg (object): Configuration object containing output directory</span>
<span class="sd">                        and resolution.</span>
<span class="sd">        singularity_path (str, optional): Path to the Singularity executable.</span>
<span class="sd">        singularity_mount (str, optional): Mount point for Singularity.</span>
<span class="sd">    Returns:</span>
<span class="sd">        str: Path to the output volume after reconstruction.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">nibabel</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nib</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">fetpype</span><span class="w"> </span><span class="kn">import</span> <span class="n">VALID_RECON_TAGS</span> <span class="k">as</span> <span class="n">VALID_TAGS</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">fetpype.nodes</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_valid_cmd</span><span class="p">,</span> <span class="n">get_directory</span><span class="p">,</span> <span class="n">get_mount_docker</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">fetpype.utils.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_and_tee</span>

    <span class="n">is_valid_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">VALID_TAGS</span><span class="p">)</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;recon&quot;</span><span class="p">)</span>
    <span class="n">output_volume</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;recon.nii.gz&quot;</span><span class="p">)</span>
    <span class="n">in_stacks_dir</span> <span class="o">=</span> <span class="n">get_directory</span><span class="p">(</span><span class="n">input_stacks</span><span class="p">)</span>
    <span class="n">in_stacks</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_stacks</span><span class="p">)</span>
    <span class="n">in_masks_dir</span> <span class="o">=</span> <span class="n">get_directory</span><span class="p">(</span><span class="n">input_masks</span><span class="p">)</span>
    <span class="n">in_masks</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_masks</span><span class="p">)</span>

    <span class="c1"># In cmd, there will be things contained in &lt;&gt;.</span>
    <span class="c1"># Check that everything that is in &lt;&gt; is in valid_tags</span>
    <span class="c1"># If not, raise an error</span>

    <span class="c1"># Replace the tags in the command</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;input_stacks&gt;&quot;</span><span class="p">,</span> <span class="n">in_stacks</span><span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;input_dir&gt;&quot;</span><span class="p">,</span> <span class="n">in_stacks_dir</span><span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;input_masks&gt;&quot;</span><span class="p">,</span> <span class="n">in_masks</span><span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;input_masks_dir&gt;&quot;</span><span class="p">,</span> <span class="n">in_masks_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;&lt;output_volume&gt;&quot;</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;output_volume&gt;&quot;</span><span class="p">,</span> <span class="n">output_volume</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;&lt;output_dir&gt;&quot;</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;output_dir&gt;&quot;</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">)</span>
        <span class="c1"># Assert that args.path_to_output is defined</span>
        <span class="k">assert</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path_to_output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;&lt;output_dir&gt; found in the command of reconstruction, &quot;</span>
            <span class="s2">&quot;but path_to_output is not defined.&quot;</span>
        <span class="p">)</span>
        <span class="n">output_volume</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path_to_output</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;&lt;input_tp&gt;&quot;</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">input_tp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">stack</span> <span class="ow">in</span> <span class="n">input_stacks</span>
                    <span class="p">]</span>
                <span class="p">),</span>
                <span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;input_tp&gt;&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">input_tp</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>

            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error when calculating &lt;input_tp&gt;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;&lt;singularity_path&gt;&quot;</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="c1"># assume that if we have a singularity path,</span>
        <span class="c1"># we are using singularity and the</span>
        <span class="c1"># parameter has been set in the config file</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;singularity_path&gt;&quot;</span><span class="p">,</span> <span class="n">singularity_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;&lt;singularity_mount&gt;&quot;</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="c1"># assume that if we have a singularity mount path,</span>
        <span class="c1"># we are using singularity and the</span>
        <span class="c1"># parameter has been set in the config file</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;singularity_mount&gt;&quot;</span><span class="p">,</span> <span class="n">singularity_mount</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;&lt;output_res&gt;&quot;</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="n">output_res</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">output_resolution</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;output_res&gt;&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_res</span><span class="p">))</span>
    <span class="k">if</span> <span class="s2">&quot;&lt;mount&gt;&quot;</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="n">mount_cmd</span> <span class="o">=</span> <span class="n">get_mount_docker</span><span class="p">(</span><span class="n">in_stacks_dir</span><span class="p">,</span> <span class="n">in_masks_dir</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;mount&gt;&quot;</span><span class="p">,</span> <span class="n">mount_cmd</span><span class="p">)</span>

    <span class="n">run_and_tee</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_volume</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="fetpype.nodes.segmentation" class="doc doc-heading">
            <code>segmentation</code>


</h2>

    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="fetpype.nodes.segmentation.run_seg_cmd" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run_seg_cmd</span><span class="p">(</span><span class="n">input_srr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">singularity_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">singularity_mount</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">singularity_home</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Run a segmentation command with the given input SRR.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_srr</code>
            </td>
            <td>
                  <code><span title="str">str</span> or <span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the input SRR file or a list
                    containing a single SRR file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cmd</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Command to run, with placeholders for input and output.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cfg</code>
            </td>
            <td>
                  <code><span title="object">object</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration object containing output directory.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>singularity_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the Singularity executable.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>singularity_mount</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Mount point for Singularity.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    str: Path to the output segmentation file after running the command.</p>


            <details class="quote">
              <summary>Source code in <code>fetpype/nodes/segmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_seg_cmd</span><span class="p">(</span>
    <span class="n">input_srr</span><span class="p">,</span>
    <span class="n">cmd</span><span class="p">,</span>
    <span class="n">cfg</span><span class="p">,</span>
    <span class="n">singularity_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">singularity_mount</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">singularity_home</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a segmentation command with the given input SRR.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_srr (str or list): Path to the input SRR file or a list</span>
<span class="sd">                                containing a single SRR file.</span>
<span class="sd">        cmd (str): Command to run, with placeholders for input and output.</span>
<span class="sd">        cfg (object): Configuration object containing output directory.</span>
<span class="sd">        singularity_path (str, optional): Path to the Singularity executable.</span>
<span class="sd">        singularity_mount (str, optional): Mount point for Singularity.</span>
<span class="sd">    Returns:</span>
<span class="sd">        str: Path to the output segmentation file after running the command.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">fetpype</span><span class="w"> </span><span class="kn">import</span> <span class="n">VALID_SEG_TAGS</span> <span class="k">as</span> <span class="n">VALID_TAGS</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">fetpype.nodes</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_valid_cmd</span><span class="p">,</span> <span class="n">get_mount_docker</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">fetpype.utils.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_and_tee</span>

    <span class="n">is_valid_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">VALID_TAGS</span><span class="p">)</span>

    <span class="c1"># Check if input_srr is a directory or a file</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_srr</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_srr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">input_srr</span> <span class="o">=</span> <span class="n">input_srr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;input_srr is a list, and contains multiple elements. &quot;</span>
                <span class="s2">&quot;It should be a single element.&quot;</span>
            <span class="p">)</span>
    <span class="c1"># Copy input_srr to input_directory</span>
    <span class="c1"># Avoid mounting problematic directories</span>
    <span class="n">input_srr_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;seg/input&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">input_srr_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cp </span><span class="si">{</span><span class="n">input_srr</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">input_srr_dir</span><span class="si">}</span><span class="s2">/input_srr.nii.gz&quot;</span><span class="p">)</span>
    <span class="n">input_srr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_srr_dir</span><span class="p">,</span> <span class="s2">&quot;input_srr.nii.gz&quot;</span><span class="p">)</span>

    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;seg/out&quot;</span><span class="p">)</span>
    <span class="n">seg</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;seg.nii.gz&quot;</span><span class="p">)</span>

    <span class="c1"># In cmd, there will be things contained in &lt;&gt;.</span>
    <span class="c1"># Check that everything that is in &lt;&gt; is in valid_tags</span>
    <span class="c1"># If not, raise an error</span>

    <span class="c1"># Replace the tags in the command</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;input_srr&gt;&quot;</span><span class="p">,</span> <span class="n">input_srr</span><span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;input_dir&gt;&quot;</span><span class="p">,</span> <span class="n">input_srr_dir</span><span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;output_seg&gt;&quot;</span><span class="p">,</span> <span class="n">seg</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;&lt;output_dir&gt;&quot;</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;output_dir&gt;&quot;</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">)</span>
        <span class="c1"># Assert that args.path_to_output is defined</span>
        <span class="k">assert</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path_to_output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;&lt;output_dir&gt; found in the command of reconstruction, &quot;</span>
            <span class="s2">&quot; but path_to_output is not defined.&quot;</span>
        <span class="p">)</span>

        <span class="n">seg</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path_to_output</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;&lt;basename&gt;&quot;</span> <span class="ow">in</span> <span class="n">seg</span><span class="p">:</span>
            <span class="c1"># Remove all extensions from the basename</span>
            <span class="c1"># (handles .nii.gz correctly)</span>
            <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">input_srr</span><span class="p">)</span>
            <span class="c1"># Remove all extensions (handles both .nii.gz and .nii cases)</span>
            <span class="n">basename_no_ext</span> <span class="o">=</span> <span class="n">basename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">seg</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;basename&gt;&quot;</span><span class="p">,</span> <span class="n">basename_no_ext</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;&lt;mount&gt;&quot;</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="n">mount_cmd</span> <span class="o">=</span> <span class="n">get_mount_docker</span><span class="p">(</span><span class="n">input_srr_dir</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;mount&gt;&quot;</span><span class="p">,</span> <span class="n">mount_cmd</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;&lt;singularity_path&gt;&quot;</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="c1"># assume that if we have a singularity path,</span>
        <span class="c1"># we are using singularity and the</span>
        <span class="c1"># parameter has been set in the config file</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;singularity_path&gt;&quot;</span><span class="p">,</span> <span class="n">singularity_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;&lt;singularity_mount&gt;&quot;</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="c1"># assume that if we have a singularity mount path,</span>
        <span class="c1"># we are using singularity and the</span>
        <span class="c1"># parameter has been set in the config file</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;singularity_mount&gt;&quot;</span><span class="p">,</span> <span class="n">singularity_mount</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;&lt;singularity_home&gt;&quot;</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="c1"># assume that if we have a singularity mount path,</span>
        <span class="c1"># we are using singularity and the</span>
        <span class="c1"># parameter has been set in the config file</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;singularity_home&gt;&quot;</span><span class="p">,</span> <span class="n">singularity_home</span><span class="p">)</span>

    <span class="n">run_and_tee</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">seg</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="fetpype.nodes.surface_extraction" class="doc doc-heading">
            <code>surface_extraction</code>


</h2>

    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="fetpype.nodes.surface_extraction.run_surf_cmd" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run_surf_cmd</span><span class="p">(</span><span class="n">input_seg</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">singularity_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">singularity_mount</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">singularity_home</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Run a segmentation command with the given input SRR.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_seg</code>
            </td>
            <td>
                  <code><span title="str">str</span> or <span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the input segmentation file or a list
                    containing a single segmentation file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cmd</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Command to run, with placeholders for input and output.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cfg</code>
            </td>
            <td>
                  <code><span title="object">object</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration object containing output directory.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>singularity_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the Singularity executable.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>singularity_mount</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Mount point for Singularity.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    str: Path to the output segmentation file after running the command.</p>


            <details class="quote">
              <summary>Source code in <code>fetpype/nodes/surface_extraction.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_surf_cmd</span><span class="p">(</span>
    <span class="n">input_seg</span><span class="p">,</span>
    <span class="n">cmd</span><span class="p">,</span>
    <span class="n">cfg</span><span class="p">,</span>
    <span class="n">singularity_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">singularity_mount</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">singularity_home</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a segmentation command with the given input SRR.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_seg (str or list): Path to the input segmentation file or a list</span>
<span class="sd">                                containing a single segmentation file.</span>
<span class="sd">        cmd (str): Command to run, with placeholders for input and output.</span>
<span class="sd">        cfg (object): Configuration object containing output directory.</span>
<span class="sd">        singularity_path (str, optional): Path to the Singularity executable.</span>
<span class="sd">        singularity_mount (str, optional): Mount point for Singularity.</span>
<span class="sd">    Returns:</span>
<span class="sd">        str: Path to the output segmentation file after running the command.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">fetpype</span><span class="w"> </span><span class="kn">import</span> <span class="n">VALID_SURF_TAGS</span> <span class="k">as</span> <span class="n">VALID_TAGS</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">fetpype.nodes</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_valid_cmd</span><span class="p">,</span> <span class="n">get_mount_docker</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">fetpype.utils.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_and_tee</span>

    <span class="n">is_valid_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">VALID_TAGS</span><span class="p">)</span>

    <span class="c1"># Check if input_srr is a directory or a file</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_seg</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_seg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">input_seg</span> <span class="o">=</span> <span class="n">input_seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;input_seg is a list, and contains multiple elements. &quot;</span>
                <span class="s2">&quot;It should be a single element.&quot;</span>
            <span class="p">)</span>
    <span class="c1"># Copy input_seg to input_directory</span>
    <span class="c1"># Avoid mounting problematic directories</span>
    <span class="n">input_seg_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;seg/input&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">input_seg_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cp </span><span class="si">{</span><span class="n">input_seg</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">input_seg_dir</span><span class="si">}</span><span class="s2">/input_seg.nii.gz&quot;</span><span class="p">)</span>
    <span class="n">input_seg</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_seg_dir</span><span class="p">,</span> <span class="s2">&quot;input_seg.nii.gz&quot;</span><span class="p">)</span>

    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;surf/out&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">surf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">out_file</span><span class="p">)</span>

    <span class="c1"># In cmd, there will be things contained in &lt;&gt;.</span>
    <span class="c1"># Check that everything that is in &lt;&gt; is in valid_tags</span>
    <span class="c1"># If not, raise an error</span>

    <span class="c1"># Replace the tags in the command</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;input_seg&gt;&quot;</span><span class="p">,</span> <span class="n">input_seg</span><span class="p">)</span>
    <span class="c1"># cmd = cmd.replace(&quot;&lt;input_dir&gt;&quot;, input_seg_dir)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;output_surf&gt;&quot;</span><span class="p">,</span> <span class="n">surf</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cfg</span><span class="o">.</span><span class="n">use_scheme</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">labelling_scheme</span><span class="p">,</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Unknown labelling scheme: </span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">use_scheme</span><span class="si">}</span><span class="s2">,&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;please choose from </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">labelling_scheme</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">labelling_scheme</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">labelling_scheme</span><span class="p">[</span><span class="n">cfg</span><span class="o">.</span><span class="n">use_scheme</span><span class="p">]</span>
    <span class="n">labelling_scheme</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">labelling_scheme</span><span class="p">))</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;labelling_scheme&gt;&quot;</span><span class="p">,</span> <span class="n">labelling_scheme</span><span class="p">)</span>

    <span class="c1"># if &quot;&lt;output_dir&gt;&quot; in cmd:</span>
    <span class="c1">#     cmd = cmd.replace(&quot;&lt;output_dir&gt;&quot;, output_dir)</span>
    <span class="c1">#     # Assert that args.path_to_output is defined</span>
    <span class="c1">#     assert cfg.path_to_output is not None, (</span>
    <span class="c1">#         &quot;&lt;output_dir&gt; found in the command of reconstruction, &quot;</span>
    <span class="c1">#         &quot; but path_to_output is not defined.&quot;</span>
    <span class="c1">#     )</span>

    <span class="c1"># seg = os.path.join(output_dir, cfg.path_to_output)</span>
    <span class="c1"># if &quot;&lt;basename&gt;&quot; in seg:</span>
    <span class="c1">#     # Remove all extensions from the basename</span>
    <span class="c1">#     # (handles .nii.gz correctly)</span>
    <span class="c1">#     basename = os.path.basename(input_srr)</span>
    <span class="c1">#     # Remove all extensions (handles both .nii.gz and .nii cases)</span>
    <span class="c1">#     basename_no_ext = basename.split(&quot;.&quot;)[0]</span>
    <span class="c1">#     seg = seg.replace(&quot;&lt;basename&gt;&quot;, basename_no_ext)</span>
    <span class="k">if</span> <span class="s2">&quot;&lt;mount&gt;&quot;</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="n">mount_cmd</span> <span class="o">=</span> <span class="n">get_mount_docker</span><span class="p">(</span><span class="n">input_seg_dir</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;mount&gt;&quot;</span><span class="p">,</span> <span class="n">mount_cmd</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;&lt;singularity_path&gt;&quot;</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;singularity_path&gt;&quot;</span><span class="p">,</span> <span class="n">singularity_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;&lt;singularity_mount&gt;&quot;</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;singularity_mount&gt;&quot;</span><span class="p">,</span> <span class="n">singularity_mount</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;&lt;singularity_home&gt;&quot;</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;singularity_home&gt;&quot;</span><span class="p">,</span> <span class="n">singularity_home</span><span class="p">)</span>

    <span class="n">run_and_tee</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">surf</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="fetpype.nodes.utils" class="doc doc-heading">
            <code>utils</code>


</h2>

    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="fetpype.nodes.utils.get_directory" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_directory</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get the directory of an entry, to be mounted on docker
If entry is a list, it returns the common path.
If entry is a string, it returns the dirname.</p>


            <details class="quote">
              <summary>Source code in <code>fetpype/nodes/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_directory</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the directory of an entry, to be mounted on docker</span>
<span class="sd">    If entry is a list, it returns the common path.</span>
<span class="sd">    If entry is a string, it returns the dirname.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">commonpath</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span><span class="si">}</span><span class="s2"> not supported&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="fetpype.nodes.utils.get_mount_docker" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_mount_docker</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Build the string for the folders to be mounted on the
docker image. The folders to be mounted are defined
in _mount_keys.</p>


            <details class="quote">
              <summary>Source code in <code>fetpype/nodes/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_mount_docker</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build the string for the folders to be mounted on the</span>
<span class="sd">    docker image. The folders to be mounted are defined</span>
<span class="sd">    in _mount_keys.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mount_args</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">mount_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;-v </span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">mount_args</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="fetpype.nodes.utils.get_run_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_run_id</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get the run ID from the file name.</p>


            <details class="quote">
              <summary>Source code in <code>fetpype/nodes/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_run_id</span><span class="p">(</span><span class="n">file_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the run ID from the file name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">runs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">runs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;run-([^\W_]+)_&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;run ID not found in file name: </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">runs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>